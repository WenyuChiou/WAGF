# Governed Broker Framework

**ğŸŒ Language / èªè¨€: [English](README.md) | [ä¸­æ–‡](README_zh.md)**

<div align="center">

**LLM é©…å‹•çš„ Agent-Based Model æ²»ç†ä¸­é–“ä»¶**

[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

</div>

## æ¨¡çµ„åŒ–ä¸­é–“ä»¶æ¶æ§‹ (Modular Middleware Architecture)

æœ¬æ¡†æ¶è¨­è¨ˆç‚ºä½æ–¼ä»£ç†äººæ±ºç­–æ¨¡å‹ (LLM) èˆ‡æ¨¡æ“¬ç’°å¢ƒ (ABM) ä¹‹é–“çš„ **æ²»ç†ä¸­é–“ä»¶ (Governance Middleware)**ã€‚æ¯å€‹çµ„ä»¶éƒ½æ˜¯è§£è€¦çš„ï¼Œå…è¨±éˆæ´»åœ°å¯¦é©—ä¸åŒçš„æ¨¡å‹ã€é©—è­‰è¦å‰‡èˆ‡ç’°å¢ƒå‹•æ…‹ã€‚

### 4 å¤§æ ¸å¿ƒæ¨¡çµ„

| æ¨¡çµ„ | è§’è‰² | èªªæ˜ |
| :--- | :--- | :--- |
| **Skill Registry** | *æ†²æ³•* | å®šç¾©ä»£ç†äºº *èƒ½åšä»€éº¼* (æŠ€èƒ½)ï¼ŒåŒ…å«æˆæœ¬ã€é™åˆ¶èˆ‡ç‰©ç†å¾Œæœã€‚ |
| **Skill Broker** | *æ³•å®˜* | æ ¸å¿ƒæ²»ç†å¼•æ“ã€‚å¼·åˆ¶åŸ·è¡Œåˆ¶åº¦èˆ‡å¿ƒç†ä¸€è‡´æ€§è¦å‰‡ ( PMT Coherence) æ–¼ LLM ææ¡ˆä¹‹ä¸Šã€‚ |
| **Sim Engine** | *ä¸–ç•Œ* | åŸ·è¡Œç²å‡†çš„å‹•ä½œä¸¦ç®¡ç†ç‰©ç†ç‹€æ…‹çš„æ¼”è®Š (ä¾‹å¦‚ï¼šæ´ªæ°´æå®³)ã€‚ |
| **Context Builder** | *æ„Ÿå®˜* | ç‚ºä»£ç†äººåˆæˆä¸€å€‹æœ‰ç•Œçš„ç¾å¯¦è¦–åœ– (å€‹äººè¨˜æ†¶ã€ç¤¾äº¤ä¿¡è™Ÿã€å…¨å±€ç‹€æ…‹)ã€‚ |

---

---

## ğŸ›¡ï¸ æ ¸å¿ƒå•é¡Œé™³è¿°

![æ ¸å¿ƒæŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ](docs/challenges_solutions_v2.png)

| æŒ‘æˆ° | å•é¡Œæè¿° | æ¡†æ¶è§£æ±ºæ–¹æ¡ˆ | çµ„ä»¶ |
| :--- | :--- | :--- | :--- |
| **å¹»è¦º (Hallucination)** | LLM ç”¢ç”Ÿç„¡æ•ˆå‹•ä½œ (ä¾‹å¦‚ "é€ ç‰†") | **åš´æ ¼è¨»å†Šè¡¨**: åƒ…æ¥å—å·²è¨»å†Šçš„ `skill_id`ã€‚ | `SkillRegistry` |
| **ä¸Šä¸‹æ–‡é™åˆ¶** | ç„¡æ³•å°‡å®Œæ•´æ­·å²å¡å…¥æç¤ºè©ã€‚ | **é¡¯è‘—æ€§è¨˜æ†¶**: åƒ…æª¢ç´¢ Top-k ç›¸é—œçš„éå»äº‹ä»¶ã€‚ | `MemoryEngine` |
| **ä¸ä¸€è‡´æ€§** | æ±ºç­–èˆ‡æ¨ç†çŸ›ç›¾ (é‚è¼¯æ¼‚ç§»)ã€‚ | **æ€è€ƒé©—è­‰å™¨**: æª¢æŸ¥ `TP`/`CP` èˆ‡ `Choice` ä¹‹é–“çš„é‚è¼¯é€£è²«æ€§ã€‚ | `SkillBrokerEngine` |
| **ä¸é€æ˜æ±ºç­–** | "ç‚ºä»€éº¼ä»£ç†äºº X åšäº† Y?" è¡Œç‚ºä½šå¤±ã€‚ | **çµæ§‹åŒ–è»Œè·¡**: å®Œæ•´è¨˜éŒ„ è¼¸å…¥ã€æ¨ç†ã€é©—è­‰ èˆ‡ çµæœã€‚ | `AuditWriter` |
| **ä¸å®‰å…¨è®Šæ›´** | LLM è¼¸å‡ºç ´å£æ¨¡æ“¬ç‹€æ…‹ã€‚ | **æ²™ç›’åŸ·è¡Œ**: ç²å‡†æŠ€èƒ½ç”±å¼•æ“åŸ·è¡Œï¼Œè€Œé LLM ç›´æ¥ä¿®æ”¹ã€‚ | `SimulationEngine` |

---

## æ¶æ§‹

### 1. å–®ä»£ç†äººè¿´åœˆ (Single-Agent Loop)

æ­¤åœ–èªªæ˜å–®å€‹ä»£ç†äººæ­¥é©Ÿçš„æµç¨‹ï¼Œå¼·èª¿å¾åŸå§‹æ•¸æ“šåˆ°å·²é©—è­‰æŠ€èƒ½çš„è½‰æ›ã€‚

![å–®ä»£ç†äººæ¶æ§‹](docs/single_agent_architecture.png)

> **é€²éšç‰ˆ (V4)**: æ›´è©³ç´°çš„ç‰ˆæœ¬è«‹åƒè¦‹ [single_agent_architecture_v4.png](docs/single_agent_architecture_v4.png)

### 2. å¤šä»£ç†äººäº’å‹• (Multi-Agent Interaction)

åœ¨å¤šä»£ç†äººæ¨¡å¼ä¸‹ï¼Œç¤¾äº¤ä¿¡è™Ÿæˆç‚ºé—œéµè¼¸å…¥ã€‚

![å¤šä»£ç†äººæ¶æ§‹](docs/multi_agent_architecture.png)

### æ¡†æ¶æ¼”é€²

![Framework Evolution](docs/framework_evolution.png)

**é·ç§»èªªæ˜**: 
- **v1 (èˆŠç‰ˆ)**: å–®é«”è…³æœ¬ã€‚
- **v2 (ç•¶å‰)**: æ¨¡çµ„åŒ– `SkillBrokerEngine` + `providers`ã€‚è«‹ä½¿ç”¨ `examples/single_agent/run_modular_experiment.py`ã€‚
æœ¬æ¡†æ¶ç¾åœ¨åŒ…å«ä¸€å€‹æ˜ç¢ºçš„ **Memory Layer (è¨˜æ†¶å±¤)**ï¼Œä½æ–¼ Governed Broker å’Œ Simulation State ä¹‹é–“ï¼Œå¢å¼·äº†ä»£ç†äººçš„ä¸€è‡´æ€§èˆ‡å­¸ç¿’èƒ½åŠ›ã€‚

### è¨˜æ†¶å…ƒä»¶
*   **Working Memory (å·¥ä½œè¨˜æ†¶)**: çŸ­æœŸå„²å­˜ç•¶ä¸‹ä¸Šä¸‹æ–‡ (ä¾‹å¦‚ï¼šæœ€è¿‘é„°å±…çš„å‹•ä½œã€ä»Šå¹´çš„æ”¿ç­–)ã€‚
*   **Episodic Memory (æƒ…ç¯€è¨˜æ†¶)**: é•·æœŸå„²å­˜é‡è¦äº‹ä»¶çš„æ­·å² (ä¾‹å¦‚ï¼šéå»çš„æ´ªæ°´ç½å®³ã€ç†è³ ç´€éŒ„ã€éå»çš„æ±ºç­–)ã€‚

### è³‡è¨Šæµ
1.  **ä¸»å‹•æª¢ç´¢ (`retrieve()`)**: 
    - åœ¨åšå‡ºæ±ºç­–ä¹‹å‰ï¼Œ**Context Builder** å‘¼å« `retrieve()` ç²å–ç›¸é—œè¨˜æ†¶ã€‚
    - *ç¯„ä¾‹*: "æª¢ç´¢éå» 3 å¹´çš„æ´ªæ°´ç½å®³å’Œç†è³ æˆåŠŸç‡ã€‚"
    - é€™äº›æ•¸æ“šæœƒè¢«æ³¨å…¥åˆ°ç™¼é€çµ¦ LLM çš„ **Bounded Context (æœ‰ç•Œä¸Šä¸‹æ–‡)** ä¸­ã€‚

2.  **è¢«å‹•å„²å­˜ (`add_memory()`)**:
    - ç•¶ **Executor** åŸ·è¡Œå·²é©—è­‰çš„æŠ€èƒ½å¾Œï¼Œè§¸ç™¼ `add_memory()`ã€‚
    - æ±ºç­–ã€çµæœä»¥åŠä»»ä½•é©—è­‰è¨»è¨˜éƒ½æœƒè¢«å„²å­˜ç‚ºæ–°çš„è¨˜æ†¶è»Œè·¡ã€‚
    - *ç¯„ä¾‹*: "æ±ºç­–ï¼šåŠ é«˜æˆ¿å±‹ (ç¬¬ 5 å¹´)ã€‚çµæœï¼šæˆåŠŸã€‚"

### å¢å¼·å‹å¯©è¨ˆ (Audit)
**Audit Writer** æ•æ‰èªçŸ¥éç¨‹çš„å®Œæ•´è»Œè·¡ï¼š
*   **Input**: æä¾›äº†ä»€éº¼ä¸Šä¸‹æ–‡/è¨˜æ†¶ï¼Ÿ
*   **Reasoning**: LLM çš„å…§éƒ¨æ¨ç†æ˜¯ä»€éº¼ï¼Ÿ
*   **Validation**: ææ¡ˆç‚ºä½•è¢«æ¥å—æˆ–æ‹’çµ•ï¼Ÿ
*   **Execution**: å¯¦éš›ç™¼ç”Ÿäº†ä»€éº¼ç‹€æ…‹è®Šæ›´ï¼Ÿ

---

## å¿«é€Ÿé–‹å§‹

```bash
# å®‰è£ä¾è³´
pip install -r requirements.txt

# åŸ·è¡Œç¯„ä¾‹å¯¦é©—
cd examples/skill_governed_flood
python run_experiment.py --model llama3.2:3b --num-agents 100 --num-years 10
```

---

## ğŸ”„ æ¡†æ¶æ¼”é€²

![æ¡†æ¶æ¼”é€²](docs/framework_evolution.png)

**No MCP â†’ MCP v1 â†’ Skill-Governed (v2)**ï¼šæ¼¸é€²å¼å¢åŠ æ²»ç†å±¤ç´šï¼Œå¯¦ç¾å¯é çš„ LLM-ABM æ•´åˆã€‚

---

## æ ¸å¿ƒå…ƒä»¶

#### ä»£ç†äººé¡å‹é…ç½® (`broker/agent_types.yaml`)

æ‰€æœ‰ä»£ç†äººè¨­ç½®éƒ½å·²å¤–éƒ¨åŒ–åˆ° **çµ±ä¸€çš„ YAML é…ç½®** ä¸­ã€‚é€™å…è¨±åœ¨ä¸ä¿®æ”¹ Python ä»£ç¢¼çš„æƒ…æ³ä¸‹æ›´æ”¹ä»£ç†äººè¡Œç‚ºã€‚

```yaml
household:
  # æ­¤ä»£ç†äººé¡å‹çš„æœ‰æ•ˆæŠ€èƒ½
  actions: 
    - id: buy_insurance
      aliases: ["Purchase Insurance"]
    - id: do_nothing
  
  # é€é get_parameters() è¨ªå•çš„é ˜åŸŸå°ˆå±¬åƒæ•¸
  parameters:
    income_threshold: 40000
    damage_threshold: 0.1
    
  # ç”¨æ–¼é©—è­‰çš„ PMT ç†è«–æ§‹å¿µ
  constructs: [TP, CP, SP, SC, PA]
```

### æä¾›è€…å±¤èˆ‡é©é…å™¨ (`providers/` & `broker/utils/`)

| çµ„ä»¶ | æª”æ¡ˆ | èªªæ˜ |
|-----------|------|-------------|
| **UnifiedAdapter** | `model_adapter.py` | ğŸ§  **æ™ºèƒ½è§£æ**ï¼šè™•ç†ç‰¹å®šæ¨¡å‹çš„æ€ªç™–ï¼ˆä¾‹å¦‚ DeepSeek çš„ `<think>` æ¨™ç±¤ã€Llama çš„ JSON æ ¼å¼ï¼‰ã€‚ |
| **LLM Utils** | `llm_utils.py` | âš¡ **é›†ä¸­èª¿ç”¨**ï¼šå…·å‚™ç©©å¥éŒ¯èª¤è™•ç†èˆ‡è©³ç´°ç¨‹åº¦æ§åˆ¶ (Verbosity control)ã€‚ |
| **OllamaProvider** | `ollama.py` | é è¨­çš„æœ¬åœ°æä¾›è€…ã€‚ |

### é©—è­‰å™¨å±¤ (`validators/`)

æˆ‘å€‘å°‡æ²»ç†è¦å‰‡åˆ†é¡ç‚ºä¸€å€‹ 2x2 çš„çŸ©é™£ï¼š

| ç¶­åº¦ | **åš´æ ¼ (é˜»æ­¢ä¸¦é‡è©¦)** | **å•Ÿç™¼å¼ (è­¦å‘Šä¸¦è¨˜éŒ„)** |
| :--- | :--- | :--- |
| **ç‰©ç† / èº«ä»½è¦å‰‡** | *ä¸å¯èƒ½çš„å‹•ä½œ* <br> (ä¾‹ï¼šã€Œå·²åŠ é«˜æˆ¿å±‹å»å†æ¬¡åŠ é«˜ã€ã€ã€Œå·²æ¬é·å»é‚„è²·ä¿éšªã€) | *å¯ç–‘ç‹€æ…‹* <br> (ä¾‹ï¼šã€Œå¯Œè£•ä»£ç†äººå»é¸æ“‡ä»€éº¼éƒ½ä¸åšã€) |
| **å¿ƒç† / æ€è€ƒè¦å‰‡** | *é‚è¼¯è¬¬èª¤* <br> (ä¾‹ï¼šã€Œé«˜å¨è„… + ä½æˆæœ¬ $\rightarrow$ é¸æ“‡ä»€éº¼éƒ½ä¸åšã€) | *è¡Œç‚ºç•°å¸¸* <br> (ä¾‹ï¼šã€Œæ¥µåº¦ç„¦æ…®å»å»¶é²è¡Œå‹•ã€) |

**å¯¦ä½œæ–¹å¼ï¼š**
- **èº«ä»½è¦å‰‡ (Identity Rules)**ï¼šæ ¹æ“šç•¶å‰ç‹€æ…‹ï¼ˆä¾†è‡ª `StateManager`ï¼‰é€²è¡Œæª¢æŸ¥ã€‚
- **æ€è€ƒè¦å‰‡ (Thinking Rules)**ï¼šæª¢æŸ¥ LLM æ¨ç†å…§å®¹çš„å…§éƒ¨ä¸€è‡´æ€§ï¼ˆä¾†è‡ª `SkillProposal`ï¼‰ã€‚

### åˆå§‹æ•¸æ“šèˆ‡ä¸Šä¸‹æ–‡é€£çµ

| çµ„ä»¶ | è§’è‰² | èªªæ˜ |
|-----------|------|-------------|
| **AttributeProvider** | *ç¨®å­* | å¾ CSV (`agent_initial_profiles.csv`) è¼‰å…¥æ½›åœ¨ä»£ç†äººå±¬æ€§æˆ–éš¨æ©Ÿç”Ÿæˆã€‚ |
| **ContextBuilder** | *é€£çµè€…* | å‹•æ…‹æå–ä¸¦æ•´åˆï¼š <br> 1. **éœæ…‹ç‰¹å¾µ** (ä¾†è‡ª AttributeProvider) <br> 2. **å‹•æ…‹ç‹€æ…‹** (ä¾†è‡ª StateManager) <br> 3. **ç¤¾äº¤ä¿¡è™Ÿ** (ä¾†è‡ª SocialNetwork) |

```mermaid
graph TD
    CSV["data/profiles.csv"] --> AP["AttributeProvider"]
    AP --"åˆå§‹ç‰¹å¾µ"--> SM["StateManager"]
    SM --"ç•¶å‰ç‹€æ…‹"--> CB["ContextBuilder"]
    SN["SocialNetwork"] --"é„°å±…è¡Œç‚º"--> CB
    CB --"æç¤ºè© (Prompt)"--> LLM
```

## ç‹€æ…‹ç®¡ç†

### ç‹€æ…‹æ‰€æœ‰æ¬Š (å¤šä»£ç†äºº)

| ç‹€æ…‹é¡å‹ | ç¯„ä¾‹ | ç¯„åœ | è®€å– | å¯«å…¥ |
|----------|------|------|------|------|
| **Individual** | `memory`, `elevated`, `has_insurance` | ä»£ç†äººç§æœ‰ | åƒ…è‡ªå·± | åƒ…è‡ªå·± |
| **Social** | `neighbor_actions`, `last_decisions` | å¯è§€å¯Ÿé„°å±… | é„°å±… | ç³»çµ± |
| **Shared** | `flood_occurred`, `year` | æ‰€æœ‰ä»£ç†äºº | å…¨éƒ¨ | ç³»çµ± |
| **Institutional** | `subsidy_rate`, `policy_mode` | æ‰€æœ‰ä»£ç†äºº | å…¨éƒ¨ | åƒ…æ”¿åºœ |

> **é‡é»**: `memory` æ˜¯ **Individual** - æ¯å€‹ä»£ç†äººæœ‰è‡ªå·±çš„è¨˜æ†¶ï¼Œä¸å…±äº«ã€‚

---

## é©—è­‰ç®¡ç·š

| éšæ®µ | é©—è­‰å™¨ | æª¢æŸ¥ |
|------|--------|------|
| 1 | Admissibility | æŠ€èƒ½å­˜åœ¨ï¼Ÿä»£ç†äººæœ‰è³‡æ ¼ä½¿ç”¨æ­¤æŠ€èƒ½ï¼Ÿ |
| 2 | Feasibility | å‰ç½®æ¢ä»¶æ»¿è¶³ï¼Ÿ(ä¾‹å¦‚ï¼Œå°šæœªåŠ é«˜) |
| 3 | Constraints | ä¸€æ¬¡æ€§ï¼Ÿå¹´åº¦é™åˆ¶ï¼Ÿ |
| 4 | Effect Safety | ç‹€æ…‹è®Šæ›´æœ‰æ•ˆï¼Ÿ |
| 5 | PMT Consistency | æ¨ç†èˆ‡æ±ºç­–ä¸€è‡´ï¼Ÿ |
| 6 | Uncertainty | å›æ‡‰æœ‰ä¿¡å¿ƒï¼Ÿ |

---

## æ¡†æ¶æ¯”è¼ƒ

| ç¶­åº¦ | å–®ä»£ç†äºº | å¤šä»£ç†äºº |
|------|----------|----------|
| ç‹€æ…‹ | åƒ… Individual | Individual + Social + Shared + Institutional |
| ä»£ç†äººé¡å‹ | 1 ç¨® | N ç¨® (å±…æ°‘ã€æ”¿åºœã€ä¿éšªå…¬å¸) |
| å¯è§€å¯Ÿ | åƒ…è‡ªå·± | è‡ªå·± + é„°å±… + ç¤¾å€çµ±è¨ˆ |
| ä¸Šä¸‹æ–‡ | ç›´æ¥ | é€é Context Builder + Social Module |
| ä½¿ç”¨æ¡ˆä¾‹ | åŸºç¤ ABM | å…·ç¤¾æœƒå‹•æ…‹çš„æ”¿ç­–æ¨¡æ“¬ |

---

## æ–‡ä»¶

- [æ¶æ§‹è©³æƒ…](docs/skill_architecture.md)
- [è‡ªè¨‚æŒ‡å—](docs/customization_guide.md)
- [å¯¦é©—è¨­è¨ˆ](docs/experiment_design_guide.md)

---

## æˆæ¬Š

MIT
